# Phase 1 ゲーム仕様書（基本対戦システム）

本ドキュメントは Phase 1（ローカル2人対戦・当たり判定の完成）に必要な仕様を、実装しやすい単位（`constants.py` / `Player` / `Collision` / `Input` / 対戦ルール）で定義する。

## 1. 基本パラメータ（`src/utils/constants.py` で定義するもの）

| カテゴリ | 定数名（例） | 型 | 推奨値（例） | 説明 |
| --- | --- | --- | --- | --- |
| 画面 | `SCREEN_WIDTH` | `int` | `800` | ウィンドウ幅 |
| 画面 | `SCREEN_HEIGHT` | `int` | `450` | ウィンドウ高さ |
| 画面 | `CAPTION` | `str` | `"PyFight Online"` | タイトルバー文字列 |
| フレーム | `FPS` | `int` | `60` | 固定フレームレート |
| 物理 | `GRAVITY` | `float` | `0.8` | 重力加速度（下方向 +） |
| 物理 | `WALK_SPEED` | `float` | `4.0` | 地上移動速度（px/frame） |
| 物理 | `JUMP_VELOCITY` | `float` | `-14.0` | ジャンプ初速（上方向 -） |
| 物理 | `GROUND_Y` | `int` | `380` | 地面のY座標（足元基準） |
| ルール | `ROUND_TIME_SECONDS` | `int` | `99` | ラウンド制限時間（秒） |
| ルール | `PLAYER_MAX_HP` | `int` | `1000` | 体力の初期値（最大HP） |

- **座標系**
  - 画面左上を `(0, 0)`。
  - `x` は右方向が +、`y` は下方向が +。

- **固定更新の前提**
  - Phase 1 は `FPS=60` 固定での更新を前提とし、物理値は「1フレームあたり」の値として調整する。

## 2. キャラクター仕様（`Player` クラス）

### 2.1 基本状態（State）

| 状態名 | 遷移条件（概要） | 代表的な挙動 |
| --- | --- | --- |
| `Idle` | 入力なし、または移動停止 | その場待機 |
| `Walk` | 左右入力がある（地上） | 左右移動、向き変更 |
| `Jump` | ジャンプ入力（地上） | 上昇→落下、着地で地上状態へ |
| `Crouching` | 下入力（地上） | しゃがみ（攻撃/ガード派生あり） |

- **向き（Facing）**
  - `facing` は `+1`（右向き） / `-1`（左向き）で管理すること。
  - 原則として「相手キャラの位置」を基準に自動更新してよい（Phase 1）。

### 2.2 攻撃動作

| 技ID（例） | 名称 | 入力 | 発生条件 | ヒット時効果 |
| --- | --- | --- | --- | --- |
| `ATTACK_STAND_LIGHT` | 立ち弱パンチ | 攻撃ボタン（パンチ） | 地上かつ `Idle/Walk` | ダメージ（小） |
| `ATTACK_CROUCH_SWEEP` | 足払い（しゃがみ攻撃） | 下 + 攻撃ボタン（キック） | 地上かつ `Crouching` | ダメージ（中）、ダウンは Phase 1 では任意 |

- **攻撃のフレーム設計（最低限）**
  - 各攻撃は「予備動作 → 攻撃判定発生 → 硬直」の流れを持つ。
  - Phase 1 ではアニメーションの代わりに `attack_timer` 等でフレーム管理してよい。

### 2.3 防御動作

| 動作 | 入力 | 成立条件 | 効果 |
| --- | --- | --- | --- |
| ガード | 後ろ入力 | 地上（`Idle/Walk/Crouching`） | 被ダメージを軽減、または無効化（Phase 1 はどちらでも可） |

- **後ろ入力の定義**
  - `facing=+1`（右向き）のとき：左入力が「後ろ」。
  - `facing=-1`（左向き）のとき：右入力が「後ろ」。

## 3. 当たり判定（Collision）

Phase 1 では、当たり判定はすべて「矩形（AABB）」で定義する。

### 3.1 判定種別

| 判定 | 用途 | 実装メモ |
| --- | --- | --- |
| Hurtbox | キャラクター本体の食らい判定 | 攻撃の `Hitbox` と重なったら被弾 |
| Hitbox | 攻撃発生時に出る攻撃判定 | 攻撃中の特定フレームのみ有効 |
| Pushbox | キャラクター同士が重ならないように押し合う判定 | 常時有効（例外は任意） |

### 3.2 優先処理（推奨）

- **Pushbox 解決**
  - プレイヤー同士の `Pushbox` が重なった場合、x方向に押し戻して重なりを解消する。

- **Hit 判定**
  - 攻撃側の `Hitbox` と防御側の `Hurtbox` の重なりを判定する。
  - ヒット時は「同一攻撃による多段ヒット」を防ぐため、攻撃ごとに `has_hit` フラグ等で **1回だけ** ダメージを与える。

## 4. 対戦ルール

### 4.1 HP（体力）

| 項目 | 値（例） |
| --- | --- |
| 初期HP | `PLAYER_MAX_HP = 1000` |
| 立ち弱パンチのダメージ | `50` |
| 足払いのダメージ | `90` |

- ダメージ値は Phase 1 の暫定値でよい（ゲーム性より実装安定を優先）。

### 4.2 タイムリミット

| 項目 | 値 |
| --- | --- |
| 制限時間 | `99` 秒 |

- カウントダウンは「ゲーム内経過時間」に連動させる。

### 4.3 勝利条件

- **KO勝ち**
  - 相手のHPを `0` にする。
- **タイムアップ判定**
  - 制限時間が `0` になった時点で、HPが多い方が勝利。
  - 同値の場合は引き分け（Phase 1 では引き分け演出は簡略化してよい）。

## 5. 操作体系（Input）

### 5.1 キー割り当て

| プレイヤー | 移動 | ジャンプ | しゃがみ | パンチ（弱） | キック/強（Phase 1 では足払いに使用） |
| --- | --- | --- | --- | --- | --- |
| P1 | A/D | W | S | F | G |
| P2 | ←/→ | ↑ | ↓ | L | K |

### 5.2 入力の抽象化（推奨）

- 低レベル入力（キー状態）をそのまま `Player` に渡さず、以下のような「意図（intent）」に変換して渡す。

| intent（例） | 型 | 説明 |
| --- | --- | --- |
| `move_x` | `int` | `-1`（左）/ `0` / `+1`（右） |
| `jump` | `bool` | ジャンプ開始トリガ |
| `crouch` | `bool` | しゃがみ保持 |
| `punch` | `bool` | パンチ（押下） |
| `kick` | `bool` | キック/強（押下） |

- Phase 1 は「同時押し」や「コマンド入力」は対象外とし、単純な押下/保持で成立する技のみ実装する。
