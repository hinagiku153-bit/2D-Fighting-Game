# 技アニメーション登録ガイド

このドキュメントでは、新しい攻撃技やアニメーションを追加する方法を説明します。

---

## 📋 目次

1. [概要](#概要)
2. [通常技の登録](#通常技の登録)
3. [特殊技の登録](#特殊技の登録)
4. [フレームデータの設定](#フレームデータの設定)
5. [アニメーションIDの確認方法](#アニメーションidの確認方法)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

技の登録には以下の3つのファイルを編集します：

1. **`src/characters/ryuko.py`** - キー入力とアニメーションの紐付け
2. **`src/characters/frame_data.py`** - 技のフレームデータ（発生、持続、硬直など）
3. **`main.py`** - キー入力の処理（通常は編集不要）

---

## 通常技の登録

### ステップ1: アニメーションIDの確認

MUGENのAIRファイルから使用したいアニメーションのアクションIDを確認します。

例：
- `[Begin Action 400]` → アクションID: **400**
- `[Begin Action 1000]` → アクションID: **1000**

### ステップ2: `ryuko.py` の編集

`src/characters/ryuko.py` の `attack_action_map` に技を追加します。

```python
attack_action_map={
    # --- パンチ系 ---
    "P1_U_LP": 400,   # Uキー: 小パンチ → AIR action 400
    "P1_I_MP": 209,   # Iキー: 中パンチ → AIR action 209
    "P1_O_HP": 1000,  # Oキー: 大パンチ → AIR action 1000
    
    # --- キック系 ---
    "P1_J_LK": 229,   # Jキー: 小キック → AIR action 229
    "P1_K_MK": 430,   # Kキー: 中キック → AIR action 430
    "P1_L_HK": 410,   # Lキー: 大キック → AIR action 410
    
    # --- 新しい技を追加する場合 ---
    # "攻撃ID": アニメーションID,  # コメント
},
```

#### 攻撃IDの命名規則

- **`P1_`**: プレイヤー1（P2はプレイヤー2）
- **`U/I/O/J/K/L`**: キー名
- **`LP/MP/HP`**: Light/Medium/Heavy Punch（小/中/大パンチ）
- **`LK/MK/HK`**: Light/Medium/Heavy Kick（小/中/大キック）

例：
- `P1_U_LP` = プレイヤー1のUキー小パンチ
- `P1_K_MK` = プレイヤー1のKキー中キック

### ステップ3: 入力分類の設定

技がパンチかキックかを分類します（コマンド技の判定に使用）。

```python
punch_attack_ids={"P1_U_LP", "P1_I_MP", "P1_O_HP", "P2_L_PUNCH"},
kick_attack_ids={"P1_J_LK", "P1_K_MK", "P1_L_HK"},
```

### ステップ4: フレームデータの設定

`src/characters/frame_data.py` の `RYUKO_FRAME_DATA` に技のデータを追加します。

```python
RYUKO_FRAME_DATA: dict[str, AttackFrameData] = {
    # 小パンチ（Uキー）
    "P1_U_LP": AttackFrameData(
        attack_id="P1_U_LP",           # 攻撃ID（ryuko.pyと一致させる）
        damage=55,                      # ダメージ
        startup_frames=4,               # 発生フレーム（攻撃開始から判定発生まで）
        active_frames=4,                # 持続フレーム（判定が出ている期間）
        recovery_frames=7,              # 硬直フレーム（攻撃後の隙）
        hit_advantage=+4,               # ヒット時有利フレーム
        guard_advantage=-1,             # ガード時有利フレーム
        knockback_px=10,                # ノックバック距離
        hitstop_frames=6,               # ヒットストップ
        hitstun_frames=10,              # ヒットストン（のけぞり）
        blockstun_frames=5,             # ガードストン（ガード硬直）
        attacker_recoil_px=1,           # 攻撃側の反動
        hitbox_width=15,                # ヒットボックスの幅
        hitbox_height=22,               # ヒットボックスの高さ
        hitbox_offset_x=0,              # ヒットボックスのX方向オフセット
        hitbox_offset_y=28,             # ヒットボックスのY方向オフセット
        input_visual_frame=0,           # 入力視覚インジケーター表示タイミング
        animation_speed=1.0,            # アニメーション速度（1.0=通常）
    ),
}
```

---

## 特殊技の登録

### 突進技（RUSH）の設定

```python
# ============================================================
# 特殊技: 突進（RUSH）
# ============================================================
# コマンド: ↙ + キック
rush_attack_ids={"P1_J_LK", "P1_K_MK", "P1_L_HK"},  # 突進技の入力判定に使うキック
rush_action_id=6520,          # 突進アニメーション: AIR action 6520
rush_sprite_key=(6520, 2),    # 突進スプライト: group 6520, index 2
```

### 波動拳（HADOKEN）の設定

```python
# ============================================================
# 特殊技: 波動拳（HADOKEN）
# ============================================================
# コマンド: ↓↘→ + パンチ
hadoken_action_candidates=[6040, 3000, 3050],  # 波動拳アニメーション候補
```

複数のアニメーションIDを指定すると、存在するものが自動的に選択されます。

### 真空波動拳（SHINKU HADOKEN）の設定

```python
# ============================================================
# 特殊技: 真空波動拳（SHINKU HADOKEN）
# ============================================================
# コマンド: ↓↘→↓↘→ + パンチ（ゲージ消費）
shinku_action_candidates=[8000],  # 真空波動拳: AIR action 8000
```

### コマンド定義の詳細

`specials` リストで特殊技のコマンドを定義します。

```python
specials=[
    SpecialSpec(
        key="HADOKEN",                  # 技の識別キー
        sequences=[
            ["DIR:D", "DIR:DF", "DIR:F", "BTN:P"],  # ↓↘→P
            ["DIR:D", "DIR:F", "BTN:P"],            # ↓→P（簡易版）
        ],
        immediate_attack_ids={"P1_U_LP", "P1_I_MP", "P1_O_HP"},  # このボタンで即発動
        early_consume_key="punch_hadoken",  # 先行入力の消費キー
        requires_power=False,               # ゲージ消費の有無
    ),
]
```

#### コマンド記号の意味

**方向キー:**
- `DIR:D` = ↓（下）
- `DIR:DF` = ↘（右下）
- `DIR:F` = →（前）
- `DIR:DB` = ↙（左下）
- `DIR:B` = ←（後ろ）
- `DIR:N` = ニュートラル

**ボタン:**
- `BTN:P` = パンチボタン
- `BTN:K` = キックボタン

---

## フレームデータの設定

### 基本パラメータ

| パラメータ | 説明 | 例 |
|----------|------|-----|
| `attack_id` | 攻撃ID（ryuko.pyと一致） | `"P1_U_LP"` |
| `damage` | ダメージ量 | `55` |
| `startup_frames` | 発生フレーム | `4` |
| `active_frames` | 持続フレーム | `4` |
| `recovery_frames` | 硬直フレーム | `7` |
| `hit_advantage` | ヒット時有利フレーム | `+4` |
| `guard_advantage` | ガード時有利フレーム | `-1` |

### ヒットボックス設定

| パラメータ | 説明 | 例 |
|----------|------|-----|
| `hitbox_width` | ヒットボックスの幅（px） | `15` |
| `hitbox_height` | ヒットボックスの高さ（px） | `22` |
| `hitbox_offset_x` | X方向オフセット（px） | `0` |
| `hitbox_offset_y` | Y方向オフセット（px） | `28` |

### アニメーション設定

| パラメータ | 説明 | 例 |
|----------|------|-----|
| `animation_speed` | アニメーション速度倍率 | `1.0`（通常）、`1.5`（1.5倍速）、`0.8`（0.8倍速） |
| `input_visual_frame` | 入力インジケーター表示フレーム | `0`（入力直後） |

### 特殊設定

| パラメータ | 説明 | 例 |
|----------|------|-----|
| `causes_knockdown` | ダウンさせるか | `True` / `False` |
| `chip_damage_ratio` | チップダメージ比率 | `0.1`（10%） |
| `recovery_bonus_frames` | 追加硬直フレーム | `6` |

---

## アニメーションIDの確認方法

### 方法1: AIRファイルを直接確認

MUGENキャラクターのAIRファイルを開き、`[Begin Action XXX]` を探します。

```
[Begin Action 400]
400,0, 0,0, 5
400,1, 0,0, 3
400,2, 0,0, 3
```

この場合、アクションID: **400**

### 方法2: Fighter Factoryを使用

1. Fighter Factoryでキャラクターを開く
2. 「Air Editor」タブを選択
3. アクション一覧からIDを確認

### 方法3: ゲーム内デバッグ表示

トレーニングモードで：
1. **F3キー**を押してデバッグ表示をオン
2. **ESC → デバッグ設定 → P1フレーム情報**をオン
3. 技を出すと「アクション: XXX」と表示される

---

## トラブルシューティング

### Q: 技を出してもアニメーションが再生されない

**A:** 以下を確認してください：
1. `attack_action_map` の攻撃IDとアニメーションIDが正しいか
2. AIRファイルに該当するアクションIDが存在するか
3. スプライトファイル（PNG）が正しく配置されているか

### Q: ヒットボックスが表示されない

**A:** 以下を確認してください：
1. **F3キー**でデバッグ表示がオンになっているか
2. `frame_data.py` に該当する攻撃IDのデータがあるか
3. `startup_frames` と `active_frames` の設定が正しいか

### Q: コマンド技が出ない

**A:** 以下を確認してください：
1. `specials` リストにコマンド定義があるか
2. `sequences` のコマンド入力が正しいか
3. `immediate_attack_ids` に該当するボタンが含まれているか
4. トレーニングモードで **ESC → デバッグ設定 → キー履歴** をオンにして入力を確認

### Q: アニメーション速度を変えたい

**A:** `frame_data.py` の `animation_speed` を変更してください：
- `1.0` = 通常速度
- `1.5` = 1.5倍速（速い）
- `0.8` = 0.8倍速（遅い）

---

## 実例: 新しい技を追加する

### 例: 「Pキー」に「超パンチ」を追加

#### 1. `ryuko.py` を編集

```python
attack_action_map={
    # 既存の技...
    "P1_U_LP": 400,
    "P1_I_MP": 209,
    "P1_O_HP": 1000,
    
    # 新しい技を追加
    "P1_P_SUPER_PUNCH": 1500,  # Pキー: 超パンチ → AIR action 1500
},

# パンチ系に追加
punch_attack_ids={"P1_U_LP", "P1_I_MP", "P1_O_HP", "P1_P_SUPER_PUNCH"},
```

#### 2. `frame_data.py` を編集

```python
RYUKO_FRAME_DATA: dict[str, AttackFrameData] = {
    # 既存の技...
    
    # 超パンチ（Pキー）
    "P1_P_SUPER_PUNCH": AttackFrameData(
        attack_id="P1_P_SUPER_PUNCH",
        damage=120,                 # 高ダメージ
        startup_frames=15,          # 遅い発生
        active_frames=8,            # 長い持続
        recovery_frames=20,         # 大きな隙
        hit_advantage=+10,
        guard_advantage=-8,
        knockback_px=30,
        hitstop_frames=12,
        hitstun_frames=30,
        blockstun_frames=12,
        attacker_recoil_px=5,
        hitbox_width=80,            # 大きなヒットボックス
        hitbox_height=40,
        hitbox_offset_x=50,
        hitbox_offset_y=20,
        causes_knockdown=True,      # ダウンさせる
        animation_speed=0.8,        # ゆっくり再生
    ),
}
```

#### 3. `main.py` でキー入力を追加（必要な場合）

通常は不要ですが、新しいキーを追加する場合は `main.py` の入力処理部分を編集します。

---

## まとめ

技の登録は以下の3ステップ：

1. **`ryuko.py`** - キーとアニメーションIDを紐付け
2. **`frame_data.py`** - フレームデータを設定
3. **テスト** - トレーニングモードで動作確認

詳細な設定は各ファイルのコメントを参照してください。
